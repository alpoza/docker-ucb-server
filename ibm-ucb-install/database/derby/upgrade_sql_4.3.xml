<?xml version="1.0"?>
<!--
- Licensed Materials - Property of IBM Corp.
- IBM UrbanCode Build
- (c) Copyright IBM Corporation 2012, 2014. All Rights Reserved.
-
- U.S. Government Users Restricted Rights - Use, duplication or disclosure restricted by
- GSA ADP Schedule Contract with IBM Corp.
-->

<change-set release="4.3">

  <library name="workflow"
      release="1.0"
      base-dir="workflow"
      file="workflow/derby/upgrade_sql_1.0.xml"
      version-table="wf_db_version"
      release-column="release_name"
      version-column="ver"/>
  />
  
  <library name="property-sheets"
      release="1.0"
      base-dir="property-sheets"
      file="property-sheets/derby/upgrade_sql_1.0.xml"
      version-table="ps_db_version"
      release-column="release_name"
      version-column="ver"/>
  />

  <change number="1">
    <description>Add in a table for issue properties</description>
    <sql separator=";">
      CREATE TABLE ISSUE_PROPERTY (
          PROP_NAME       VARCHAR(255) NOT NULL,
          PROP_VALUE      VARCHAR(4000),
          ISSUE           VARCHAR(36) NOT NULL
      );
      
      INSERT INTO REP_FACT_TABLE (ID, NAME, DESCRIPTION, DISPLAY_NAME)
          VALUES ('00000000-0000-0000-0000-000000000030', 'ISSUE_PROPERTY', 'A property for an issue', 'Issue Properties');

      INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
          VALUES ('00000000-0000-0000-0000-000000000030', 'PROP_NAME', 'The name of the property', 0);
      INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
          VALUES ('00000000-0000-0000-0000-000000000030', 'PROP_VALUE', 'The value of the property', 0);
      INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
          VALUES ('00000000-0000-0000-0000-000000000030', 'ISSUE', 'The issue this property belongs to', 0, '00000000-0000-0000-0000-000000000023');
    </sql>
  </change>
  <change number="2">
    <description>High availability workflow storage changes.</description>
    <changeref library="workflow" change="10"/>
  </change>
  <change number="3">
    <description>Change boolean column types in workflow storage.</description>
    <changeref library="workflow" change="11"/>
  </change>
  <change number="4">
    <description>Prepare schema for trace data reformatting</description>
    <changeref library="workflow" change="12"/>
  </change>
  <change number="5">
    <description>Condense workflow trace data into one table</description>
    <changeref library="workflow" change="13"/>
  </change>
  <change number="6">
    <description>Remove old trace tables</description>
    <changeref library="workflow" change="14"/>
  </change>
  <change number="7">
    <description>Add tables to support reporting of agent utilization, load and queueing.</description>
    <sql separator=";">
CREATE TABLE AGENT_DIM (
    ID                   VARCHAR(36) NOT NULL PRIMARY KEY,
    ENDPOINT_ID          VARCHAR(50) NOT NULL,
    NAME                 VARCHAR(255) NOT NULL
);

CREATE TABLE JOB_DIM (
    ID                   VARCHAR(36) NOT NULL PRIMARY KEY,
    JOB_ID               BIGINT NOT NULL,
    NAME                 VARCHAR(255) NOT NULL
);

CREATE TABLE JOB_EXECUTION (
    JOB_INSTANCE_ID   BIGINT NOT NULL,
    JOB               VARCHAR(36) NOT NULL,
    AGENT             VARCHAR(36),
    PROJECT           VARCHAR(36) NOT NULL,
    PROCESS_EXECUTION VARCHAR(36),
    QUEUE_DATE        VARCHAR(36) NOT NULL,
    QUEUE_TIME        VARCHAR(36) NOT NULL,
    START_DATE        VARCHAR(36) NOT NULL,
    START_TIME        VARCHAR(36) NOT NULL,
    END_DATE          VARCHAR(36) NOT NULL,
    END_TIME          VARCHAR(36) NOT NULL,
    QUEUE_DURATION    BIGINT NOT NULL,
    EXEC_DURATION     BIGINT NOT NULL,
    RESULT            VARCHAR(10) NOT NULL
);

INSERT INTO REP_DIMENSION (ID, NAME, DISPLAY_NAME, DESCRIPTION, MUTABLE)
    VALUES ('00000000-0000-0000-0000-000000000031', 'AGENT_DIM', 'Agent', 'Agent', 1);

INSERT INTO REP_DIMENSION_COLUMN (PARENT_ID, NAME, DESCRIPTION, NULLABLE, PRIMARY_KEY)
    VALUES ('00000000-0000-0000-0000-000000000031', 'ENDPOINT_ID', 'The communication endpoint id of the agent', 0, 1);
INSERT INTO REP_DIMENSION_COLUMN (PARENT_ID, NAME, DESCRIPTION, NULLABLE, PRIMARY_KEY)
    VALUES ('00000000-0000-0000-0000-000000000031', 'NAME', 'The name of the agent', 0, 0);
    

INSERT INTO REP_DIMENSION (ID, NAME, DISPLAY_NAME, DESCRIPTION, MUTABLE)
    VALUES ('00000000-0000-0000-0000-000000000032', 'JOB_DIM', 'Job', 'Job', 1);

INSERT INTO REP_DIMENSION_COLUMN (PARENT_ID, NAME, DESCRIPTION, NULLABLE, PRIMARY_KEY)
    VALUES ('00000000-0000-0000-0000-000000000032', 'JOB_ID', 'The id of the job', 0, 1);
INSERT INTO REP_DIMENSION_COLUMN (PARENT_ID, NAME, DESCRIPTION, NULLABLE, PRIMARY_KEY)
    VALUES ('00000000-0000-0000-0000-000000000032', 'NAME', 'The name of the job', 0, 0);


INSERT INTO REP_FACT_TABLE (ID, NAME, DESCRIPTION, DISPLAY_NAME)
    VALUES ('00000000-0000-0000-0000-000000000033', 'JOB_EXECUTION', 'Execution of a job in a process', 'Job Execution');

INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
    VALUES ('00000000-0000-0000-0000-000000000033', 'JOB_INSTANCE_ID', 'The id of the job execution', 0);
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'JOB', 'The id of the job configuration', 0, '00000000-0000-0000-0000-000000000032');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'AGENT', 'The id of the agent', 1, '00000000-0000-0000-0000-000000000031');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'PROJECT', 'The id of the project', 0, '00000000-0000-0000-0000-000000000008');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
    VALUES ('00000000-0000-0000-0000-000000000033', 'PROCESS_EXECUTION', 'The id of the process instance.', 1);
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'QUEUE_DATE', 'The date this job was queued', 0, '00000000-0000-0000-0000-000000000001');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'QUEUE_TIME', 'The time this job was queued', 0, '00000000-0000-0000-0000-000000000002');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'START_DATE', 'The date this job started', 0, '00000000-0000-0000-0000-000000000001');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'START_TIME', 'The time this job started', 0, '00000000-0000-0000-0000-000000000002');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'END_DATE', 'The date this job finished', 0, '00000000-0000-0000-0000-000000000001');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
    VALUES ('00000000-0000-0000-0000-000000000033', 'END_TIME', 'The time this job finished', 0, '00000000-0000-0000-0000-000000000002');
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
    VALUES ('00000000-0000-0000-0000-000000000033', 'QUEUE_DURATION', 'The duration of the job waiting for a agent.', 0);
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
    VALUES ('00000000-0000-0000-0000-000000000033', 'EXEC_DURATION', 'The duration of the job execution once it has started.', 0);
INSERT INTO REP_FACT_TABLE_COLUMN (FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
    VALUES ('00000000-0000-0000-0000-000000000033', 'RESULT', 'The result of the job.', 0);
    </sql>
  </change>
  <change number="8">
    <description>Add security for the Agents tab</description>
    <sql separator=";">
      insert into sec_action (id, version, name, description, enabled, cascading, sec_resource_type_id)
          values ('00000000-0000-0000-0000-000000000103', 0, 'Agent View', 'Ability to view agents and their configurations.', 1, 0, '00000000-0000-0000-0000-000000100022');
      
      insert into sec_action (id, version, name, description, enabled, cascading, sec_resource_type_id)
          values ('00000000-0000-0000-0000-000000000104', 0, 'Agent Management', 'Ability to create, edit, and delete agents.', 1, 0, '00000000-0000-0000-0000-000000100022');
    </sql>
    <groovy file="4.3/ub_008_add_agent_actions_to_roles.groovy"/>
  </change>
  <change number="9">
    <description>Add optional owner field to issues</description>
    <sql separator=";">
      ALTER TABLE ISSUE_DIM ADD COLUMN OWNER VARCHAR(128);

      INSERT INTO REP_DIMENSION_COLUMN (PARENT_ID, NAME, DESCRIPTION, NULLABLE, PRIMARY_KEY)
      VALUES ('00000000-0000-0000-0000-000000000023', 'OWNER', 'The owner of the issue', 1, 0);
    </sql>
  </change>
  <change number="10">
    <description>Add source analytic summary reporting.</description>
    <sql separator=";">
CREATE TABLE SOURCE_ANALYTIC_SUMMARY (
    REPORT                 VARCHAR(36) NOT NULL,
    NAME                   VARCHAR(512) NOT NULL,
    SEVERITY               VARCHAR(255) NOT NULL,
    FINDING_COUNT          BIGINT NOT NULL,
    FINDING_URL_LINK       VARCHAR(512),
    DESCRIPTION            CLOB
);

INSERT INTO REP_FACT_TABLE (ID, NAME, DESCRIPTION, DISPLAY_NAME)
    VALUES ('00000000-0000-0000-0000-000000000034', 'SOURCE_ANALYTIC_SUMMARY', 'Source Analytic Summaries', 'Source analytics grouped into counts by finding type.');

INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE, DIMENSION_ID)
VALUES('00000000-0000-0000-0000-000000000034', 'REPORT', 'The report for the source analytic findings', 0, '00000000-0000-0000-0000-000000000026');
INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
VALUES('00000000-0000-0000-0000-000000000034', 'NAME', 'The name of the source analytic finding', 0);
INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
VALUES('00000000-0000-0000-0000-000000000034', 'SEVERITY', 'The severity of the source analytic finding', 0);
INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
VALUES('00000000-0000-0000-0000-000000000034', 'FINDING_COUNT', 'The number of findings found in the report', 0);
INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
VALUES('00000000-0000-0000-0000-000000000034', 'FINDING_URL_LINK', 'The URL link for the finding', 1);
INSERT INTO REP_FACT_TABLE_COLUMN(FACT_TABLE_ID, NAME, DESCRIPTION, NULLABLE)
VALUES('00000000-0000-0000-0000-000000000034', 'DESCRIPTION', 'The description of the source analytic finding', 1);
    </sql>
  </change>
  <change number="11">
    <description>Add pattern for Property Definition.</description>
    <changeref library="property-sheets" change="6"/>
  </change>
  <change number="12">
    <description>Update FKs in reporting tables.</description>
    <sql separator=";">
ALTER TABLE ISSUE_PROPERTY ADD CONSTRAINT IP_ISSUE_FK
    FOREIGN KEY (ISSUE)
    REFERENCES ISSUE_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_ISSUE_FK
    FOREIGN KEY (JOB)
    REFERENCES JOB_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_AGENT_FK
    FOREIGN KEY (AGENT)
    REFERENCES AGENT_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_PROJECT_FK
    FOREIGN KEY (PROJECT)
    REFERENCES PROJECT_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_QUEUE_DATE_FK
    FOREIGN KEY (QUEUE_DATE)
    REFERENCES DATE_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_QUEUE_TIME_FK
    FOREIGN KEY (QUEUE_TIME)
    REFERENCES TIME_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_START_DATE_FK
    FOREIGN KEY (START_DATE)
    REFERENCES DATE_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_START_TIME_FK
    FOREIGN KEY (START_TIME)
    REFERENCES TIME_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_END_DATE_FK
    FOREIGN KEY (END_DATE)
    REFERENCES DATE_DIM(ID)
;

ALTER TABLE JOB_EXECUTION ADD CONSTRAINT JE_END_TIME_FK
    FOREIGN KEY (END_TIME)
    REFERENCES TIME_DIM(ID)
;

ALTER TABLE SOURCE_ANALYTIC_SUMMARY ADD CONSTRAINT SAS_REPORT_FK
    FOREIGN KEY (REPORT)
    REFERENCES SOURCE_ANALYTIC_REPORT_DIM(ID)
;
    </sql>
  </change>
  <change number="13">
    <description>Remove unique constraints for properties.</description>
    <changeref library="property-sheets" change="7"/>
  </change>
  <change number="14">
    <description>Clean up orphaned security resource entries.</description>
    <sql separator=";">
DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000004'
AND id NOT IN (SELECT RESOURCE_ID FROM PROJECT));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000004'
AND id NOT IN (SELECT RESOURCE_ID FROM PROJECT);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000006'
AND id NOT IN (SELECT RESOURCE_ID FROM AGENT_POOL));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000006'
AND id NOT IN (SELECT RESOURCE_ID FROM AGENT_POOL);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000007'
AND id NOT IN (SELECT RESOURCE_ID FROM WORKFLOW));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000007'
AND id NOT IN (SELECT RESOURCE_ID FROM WORKFLOW);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000008'
AND id NOT IN (SELECT RESOURCE_ID FROM CODESTATION_PROJECT));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000008'
AND id NOT IN (SELECT RESOURCE_ID FROM CODESTATION_PROJECT);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000009'
AND id NOT IN (SELECT RESOURCE_ID FROM REPOSITORY));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000009'
AND id NOT IN (SELECT RESOURCE_ID FROM REPOSITORY);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000011'
AND id NOT IN (SELECT RESOURCE_ID FROM WORKFLOW_DEFINITION));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000011'
AND id NOT IN (SELECT RESOURCE_ID FROM WORKFLOW_DEFINITION);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000021'
AND id NOT IN (SELECT RESOURCE_ID FROM PROJECT_TEMPLATE));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000000021'
AND id NOT IN (SELECT RESOURCE_ID FROM PROJECT_TEMPLATE);

DELETE FROM sec_resource_for_team
WHERE sec_resource_id IN (SELECT id FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000100000'
AND id NOT IN (SELECT RESOURCE_ID FROM REP_REPORT));

DELETE FROM sec_resource
WHERE sec_resource_type_id = '00000000-0000-0000-0000-000000100000'
AND id NOT IN (SELECT RESOURCE_ID FROM REP_REPORT);
    </sql>
  </change>
</change-set>